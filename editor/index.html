<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>RPG DREAM EDITOR</title>
<style>
:root{
 --bg:#0b0718;--panel:#16102a;--stroke:#3a2b7a;--primary:#7b5cff;
 --text:#efeaff;--white:#ffffff
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);
 font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif}
#topbar{display:flex;align-items:center;gap:8px;padding:10px;
 background:var(--panel);border-bottom:1px solid var(--stroke)}
#topbar .spacer{flex:1}
button{background:var(--primary);border:none;border-radius:12px;
 color:#fff;padding:8px 12px;font-size:13px}
button.secondary{background:transparent;border:1px solid var(--primary)}
button.active{outline:2px solid #fff}
select,input{
 background:#120b22;color:var(--white);
 border:1px solid var(--stroke);border-radius:10px;padding:6px;width:100%
}
canvas{display:block;touch-action:none}
#toolbar{display:flex;gap:8px;padding:8px;background:#120b22;
 border-bottom:1px solid var(--stroke)}
.tool-modal{position:fixed;right:12px;top:120px;background:var(--panel);
 border:1px solid var(--stroke);border-radius:14px;padding:12px;
 min-width:280px;z-index:10}
.tool-modal.hidden{display:none}
.tool-modal h4{margin:0 0 8px 0}
.tool-modal .close{float:right;background:transparent;color:#fff}
label{font-size:12px;opacity:.85;margin-top:8px;display:block}
.toggle{display:flex;align-items:center;gap:8px;margin-top:8px}
#phaseLabel{
 position:fixed;left:50%;bottom:6px;transform:translateX(-50%);
 color:#7bffcc;font-weight:700;letter-spacing:.08em;
 text-shadow:0 0 6px rgba(123,255,204,.6)
}
#toast{
 position:fixed;left:50%;bottom:40px;transform:translateX(-50%);
 background:#1b1340;border:1px solid var(--stroke);
 border-radius:12px;padding:8px 12px;font-size:12px;display:none
}
</style>
</head>
<body>

<div id="topbar">
 <strong>Editor</strong>
 <div class="spacer"></div>
 <button id="saveBtn">Save</button>
</div>

<div id="toolbar">
 <button id="toolPaint">Paint</button>
 <button id="toolErase" class="secondary">Erase</button>
 <button id="toolPan" class="secondary">Pan</button>
 <button id="toolRegion" class="secondary">Region</button>
 <button id="toolObject" class="secondary">Object</button>
 <button id="toolMusic" class="secondary">Music</button>
</div>

<canvas id="canvas"></canvas>

<div id="musicModal" class="tool-modal hidden">
 <button class="close" onclick="closeModals()">✕</button>
 <h4>Music (Map-Level)</h4>

 <label>Entrance / Default</label>
 <input id="musicEntrance" type="text" placeholder="entrance_theme.mp3"/>

 <label>Battle</label>
 <input id="musicBattle" type="text" placeholder="battle_theme.mp3"/>

 <label>Boss</label>
 <input id="musicBoss" type="text" placeholder="boss_theme.mp3"/>

 <div class="toggle">
  <input id="musicContinuous" type="checkbox"/>
  <label for="musicContinuous" style="margin:0">Continuous play</label>
 </div>

 <div style="font-size:11px;opacity:.7;margin-top:8px">
  Music switches based on region type (battle / boss).
 </div>
</div>

<div id="phaseLabel">PHASE 14F</div>
<div id="toast">Saved ✔</div>

<script>
const active = JSON.parse(localStorage.getItem("rpgdream_active_project")||"null");
if(!active){ location.href="../manager/index.html"; }

active.data = active.data || {};
active.data.map = active.data.map || {};
active.data.map.music = active.data.map.music || {
 entrance:"", battle:"", boss:"", continuous:true
};

const music = active.data.map.music;

musicEntrance.value = music.entrance || "";
musicBattle.value   = music.battle   || "";
musicBoss.value     = music.boss     || "";
musicContinuous.checked = music.continuous !== false;

function applyMusic(){
 music.entrance = musicEntrance.value.trim();
 music.battle   = musicBattle.value.trim();
 music.boss     = musicBoss.value.trim();
 music.continuous = musicContinuous.checked;
}

function closeModals(){
 document.querySelectorAll(".tool-modal").forEach(m=>m.classList.add("hidden"));
}
function setTool(t){
 document.querySelectorAll("#toolbar button").forEach(b=>b.classList.remove("active"));
 closeModals();
 if(t==="music"){ toolMusic.classList.add("active"); musicModal.classList.remove("hidden"); }
}
toolMusic.onclick=()=>setTool("music");

saveBtn.onclick=()=>{
 applyMusic();
 const projects=JSON.parse(localStorage.getItem("rpgdream_projects")||"[]");
 const idx=projects.findIndex(p=>p.id===active.id);
 if(idx>=0) projects[idx]=active;
 else projects.push(active);
 localStorage.setItem("rpgdream_projects",JSON.stringify(projects));
 toast.style.display="block";
 setTimeout(()=>toast.style.display="none",900);
};

const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
function resize(){
 canvas.width=innerWidth; canvas.height=innerHeight-120;
 ctx.clearRect(0,0,canvas.width,canvas.height);
 ctx.fillStyle="#1b1340"; ctx.fillRect(0,0,canvas.width,canvas.height);
}
window.addEventListener("resize",resize);
resize();
</script>
</body>
</html>
