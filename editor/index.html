<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>RPG DREAM EDITOR</title>
<style>
:root{--bg:#0b0718;--panel:#16102a;--stroke:#3a2b7a;--primary:#7b5cff;--text:#efeaff}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif}
#topbar{display:flex;align-items:center;gap:8px;padding:10px;background:var(--panel);border-bottom:1px solid var(--stroke)}
#topbar .spacer{flex:1}
button{background:var(--primary);border:none;border-radius:12px;color:#fff;padding:8px 12px;font-size:13px}
button.secondary{background:transparent;border:1px solid var(--primary)}
button.active{outline:2px solid #fff}
canvas{display:block;touch-action:none}
#toolbar{display:flex;gap:8px;padding:8px;background:#120b22;border-bottom:1px solid var(--stroke)}
.tool-modal{position:fixed;right:12px;top:120px;background:var(--panel);border:1px solid var(--stroke);border-radius:14px;padding:12px;min-width:220px;z-index:10}
.tool-modal.hidden{display:none}
.tool-modal h4{margin:0 0 8px 0}
.tool-modal .close{float:right;background:transparent;color:#fff}
#toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#1b1340;border:1px solid var(--stroke);border-radius:12px;padding:8px 12px;font-size:12px;display:none}
</style>
</head>
<body>
<div id="topbar">
  <strong>Editor</strong>
  <div class="spacer"></div>
  <button id="saveBtn">Save</button>
</div>
<div id="toolbar">
  <button id="toolPaint">Paint</button>
  <button id="toolErase" class="secondary">Erase</button>
  <button id="toolPan" class="secondary">Pan</button>
  <button id="toolRegion" class="secondary">Region</button>
</div>
<canvas id="canvas"></canvas>

<div id="regionModal" class="tool-modal hidden">
  <button class="close" onclick="closeModals()">âœ•</button>
  <h4>Regions</h4>
  <div style="font-size:12px;opacity:.8">Active region:</div>
  <select id="regionSelect"></select>
  <div style="margin-top:8px;display:flex;gap:8px">
    <button id="newRegionBtn" class="secondary">+ New</button>
    <button id="eraseRegionTileBtn" class="secondary">Erase Tile</button>
  </div>
</div>

<div id="toast">Saved</div>

<script>
const active = JSON.parse(localStorage.getItem("rpgdream_active_project")||"null");
if(!active){ location.href="../manager/index.html"; }

const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
let dpr=window.devicePixelRatio||1, scale=1, offsetX=0, offsetY=0;
const tileSize=Number(active.tile)||32;
const viewMode=active.view||"topdown";

const GRID_PRESETS={small:20, medium:40, large:80};
const GRID_MAX=GRID_PRESETS[active.grid]||40;

const terrain=new Map();
const regions={};
let activeRegionId=null;

let currentTool="paint";
let isPanning=false, panStart={x:0,y:0}, camStart={x:0,y:0};

function resize(){
  canvas.width=innerWidth*dpr;
  canvas.height=(innerHeight-120)*dpr;
  canvas.style.width=innerWidth+"px";
  canvas.style.height=(innerHeight-120)+"px";
  ctx.setTransform(dpr,0,0,dpr,0,0);
  draw();
}
window.addEventListener("resize",resize);

function gridToScreen(x,y){
  if(viewMode==="angular"){ return { x:(x-y)*(tileSize/2), y:(x+y)*(tileSize/4) }; }
  return { x:x*tileSize, y:y*tileSize };
}
function screenToGrid(px,py){
  if(viewMode==="angular"){
    const gx=Math.round((px/(tileSize/2)+py/(tileSize/4))/2);
    const gy=Math.round((py/(tileSize/4)-px/(tileSize/2))/2);
    return {x:gx,y:gy};
  }
  return {x:Math.floor(px/tileSize),y:Math.floor(py/tileSize)};
}

function draw(){
  ctx.save();
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.translate(offsetX,offsetY);
  ctx.scale(scale,scale);

  ctx.strokeStyle="rgba(255,255,255,.15)";
  for(let x=-GRID_MAX;x<=GRID_MAX;x++)for(let y=-GRID_MAX;y<=GRID_MAX;y++){
    const p=gridToScreen(x,y);
    if(viewMode==="angular"){
      ctx.beginPath();
      ctx.moveTo(p.x, p.y-tileSize/4);
      ctx.lineTo(p.x+tileSize/2, p.y);
      ctx.lineTo(p.x, p.y+tileSize/4);
      ctx.lineTo(p.x-tileSize/2, p.y);
      ctx.closePath(); ctx.stroke();
    } else ctx.strokeRect(p.x,p.y,tileSize,tileSize);
  }

  ctx.fillStyle="#7b5cff";
  terrain.forEach((_,k)=>{
    const [x,y]=k.split(",").map(Number);
    const p=gridToScreen(x,y);
    if(viewMode==="angular"){
      ctx.beginPath();
      ctx.moveTo(p.x, p.y-tileSize/4);
      ctx.lineTo(p.x+tileSize/2, p.y);
      ctx.lineTo(p.x, p.y+tileSize/4);
      ctx.lineTo(p.x-tileSize/2, p.y);
      ctx.closePath(); ctx.fill();
    } else ctx.fillRect(p.x,p.y,tileSize,tileSize);
  });

  Object.values(regions).forEach(r=>{
    ctx.fillStyle="rgba(255,80,120,0.35)";
    r.tiles.forEach(key=>{
      const [x,y]=key.split(",").map(Number);
      const p=gridToScreen(x,y);
      if(viewMode==="angular"){
        ctx.beginPath();
        ctx.moveTo(p.x, p.y-tileSize/4);
        ctx.lineTo(p.x+tileSize/2, p.y);
        ctx.lineTo(p.x, p.y+tileSize/4);
        ctx.lineTo(p.x-tileSize/2, p.y);
        ctx.closePath(); ctx.fill();
      } else ctx.fillRect(p.x,p.y,tileSize,tileSize);
    });
  });

  ctx.restore();
}

canvas.addEventListener("pointerdown",e=>{
  const rect=canvas.getBoundingClientRect();
  const px=(e.clientX-rect.left-offsetX)/scale;
  const py=(e.clientY-rect.top-offsetY)/scale;

  if(currentTool==="pan"){
    isPanning=true; panStart={x:e.clientX,y:e.clientY}; camStart={x:offsetX,y:offsetY}; return;
  }

  const g=screenToGrid(px,py);
  if(g.x<-GRID_MAX||g.x>GRID_MAX||g.y<-GRID_MAX||g.y>GRID_MAX) return;

  const key=g.x+","+g.y;
  if(currentTool==="paint") terrain.set(key,true);
  if(currentTool==="erase") terrain.delete(key);
  if(currentTool==="region" && activeRegionId){
    regions[activeRegionId].tiles.add(key);
  }
  draw();
});

canvas.addEventListener("pointermove",e=>{
  if(currentTool==="pan" && isPanning){
    offsetX=camStart.x+(e.clientX-panStart.x);
    offsetY=camStart.y+(e.clientY-panStart.y);
    draw();
  }
});
canvas.addEventListener("pointerup",()=>isPanning=false);
canvas.addEventListener("pointerleave",()=>isPanning=false);

function closeModals(){ document.querySelectorAll('.tool-modal').forEach(m=>m.classList.add('hidden')); }
function setTool(t){
  currentTool=t;
  document.querySelectorAll('#toolbar button').forEach(b=>b.classList.remove('active'));
  closeModals();
  if(t==="paint") toolPaint.classList.add('active');
  if(t==="erase") toolErase.classList.add('active');
  if(t==="pan") toolPan.classList.add('active');
  if(t==="region"){ toolRegion.classList.add('active'); regionModal.classList.remove('hidden'); }
}
toolPaint.onclick=()=>setTool("paint");
toolErase.onclick=()=>setTool("erase");
toolPan.onclick=()=>setTool("pan");
toolRegion.onclick=()=>setTool("region");
setTool("paint");

function refreshRegionSelect(){
  regionSelect.innerHTML="";
  Object.keys(regions).forEach(id=>{
    const o=document.createElement("option");
    o.value=id; o.textContent=id;
    regionSelect.appendChild(o);
  });
  if(activeRegionId) regionSelect.value=activeRegionId;
}

newRegionBtn.onclick=()=>{
  const id="region_"+String(Object.keys(regions).length+1).padStart(3,"0");
  regions[id]={ id, type:"custom", tiles:new Set() };
  activeRegionId=id;
  refreshRegionSelect();
};

eraseRegionTileBtn.onclick=()=>{
  if(!activeRegionId) return;
  currentTool="regionErase";
};

regionSelect.onchange=e=>activeRegionId=e.target.value;

function serialize(){
  const projects=JSON.parse(localStorage.getItem("rpgdream_projects")||"[]");
  const payload={ map:{ terrain:Object.fromEntries(terrain), regions:{} } };
  Object.values(regions).forEach(r=>payload.map.regions[r.id]={ type:r.type, tiles:[...r.tiles] });
  const idx=projects.findIndex(p=>p.id===active.id);
  if(idx>=0) projects[idx].data=payload;
  localStorage.setItem("rpgdream_projects",JSON.stringify(projects));
}
function toast(){ toastEl.style.display="block"; setTimeout(()=>toastEl.style.display="none",900); }
saveBtn.onclick=()=>{ serialize(); toast(); };
const toastEl=document.getElementById('toast');

resize(); draw();
</script>
</body>
</html>
