<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>RPG DREAM EDITOR</title>
<style>
:root{
  --bg:#0b0718;--panel:#16102a;--stroke:#3a2b7a;--primary:#7b5cff;
  --text:#efeaff;--white:#ffffff
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);
  font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif}
#topbar{display:flex;align-items:center;gap:8px;padding:10px;
  background:var(--panel);border-bottom:1px solid var(--stroke)}
#topbar .spacer{flex:1}
button{background:var(--primary);border:none;border-radius:12px;
  color:#fff;padding:8px 12px;font-size:13px}
button.secondary{background:transparent;border:1px solid var(--primary)}
button.active{outline:2px solid #fff}
select{
  background:#120b22;color:var(--white);
  border:1px solid var(--stroke);border-radius:10px;padding:6px
}
canvas{display:block;touch-action:none}
#toolbar{display:flex;gap:8px;padding:8px;background:#120b22;
  border-bottom:1px solid var(--stroke)}
.tool-modal{position:fixed;right:12px;top:120px;background:var(--panel);
  border:1px solid var(--stroke);border-radius:14px;padding:12px;
  min-width:260px;z-index:10}
.tool-modal.hidden{display:none}
.tool-modal h4{margin:0 0 8px 0}
.tool-modal .close{float:right;background:transparent;color:#fff}
#phaseLabel{
  position:fixed;left:50%;bottom:6px;transform:translateX(-50%);
  color:#7bffcc;font-weight:700;letter-spacing:.08em;
  text-shadow:0 0 6px rgba(123,255,204,.6)
}
</style>
</head>
<body>
<div id="topbar">
  <strong>Editor</strong>
  <div class="spacer"></div>
  <button id="saveBtn">Save</button>
</div>

<div id="toolbar">
  <button id="toolPaint">Paint</button>
  <button id="toolErase" class="secondary">Erase</button>
  <button id="toolPan" class="secondary">Pan</button>
  <button id="toolRegion" class="secondary">Region</button>
  <button id="toolObject" class="secondary">Object</button>
</div>

<canvas id="canvas"></canvas>

<div id="phaseLabel">PHASE 14E.1</div>

<script>
const active = JSON.parse(localStorage.getItem("rpgdream_active_project")||"null");
if(!active){ location.href="../manager/index.html"; }

// ---- View mode rehydration (FIX) ----
const VIEW_MODE = active.view === "angular" ? "angular" : "topdown";

const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
let dpr=window.devicePixelRatio||1;
let scale=1, offsetX=0, offsetY=0;
const MIN_ZOOM=.5, MAX_ZOOM=2.5;

const tileSize=Number(active.tile)||32;
const GRID_PRESETS={small:20, medium:40, large:80};
const GRID_MAX=GRID_PRESETS[active.grid]||40;

// Data layers
const terrain=new Map(Object.entries(active?.data?.map?.terrain||{}));
const regions=active?.data?.map?.regions||{};
const objects=active?.data?.map?.objects||[];

// ---- Math helpers bound to VIEW_MODE ----
function gridToScreen(x,y){
  if(VIEW_MODE==="angular"){
    return { x:(x-y)*(tileSize/2), y:(x+y)*(tileSize/4) };
  }
  return { x:x*tileSize, y:y*tileSize };
}
function screenToGrid(px,py){
  if(VIEW_MODE==="angular"){
    const gx=Math.round((px/(tileSize/2)+py/(tileSize/4))/2);
    const gy=Math.round((py/(tileSize/4)-px/(tileSize/2))/2);
    return {x:gx,y:gy};
  }
  return {x:Math.floor(px/tileSize),y:Math.floor(py/tileSize)};
}

function resize(){
  canvas.width=innerWidth*dpr;
  canvas.height=(innerHeight-120)*dpr;
  canvas.style.width=innerWidth+"px";
  canvas.style.height=(innerHeight-120)+"px";
  ctx.setTransform(dpr,0,0,dpr,0,0);
  draw();
}
window.addEventListener("resize",resize);

function draw(){
  ctx.save();
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.translate(offsetX,offsetY);
  ctx.scale(scale,scale);

  // grid
  ctx.strokeStyle="rgba(255,255,255,.15)";
  for(let x=-GRID_MAX;x<=GRID_MAX;x++)for(let y=-GRID_MAX;y<=GRID_MAX;y++){
    const p=gridToScreen(x,y);
    if(VIEW_MODE==="angular"){
      ctx.beginPath();
      ctx.moveTo(p.x, p.y-tileSize/4);
      ctx.lineTo(p.x+tileSize/2, p.y);
      ctx.lineTo(p.x, p.y+tileSize/4);
      ctx.lineTo(p.x-tileSize/2, p.y);
      ctx.closePath(); ctx.stroke();
    } else {
      ctx.strokeRect(p.x,p.y,tileSize,tileSize);
    }
  }

  // terrain
  ctx.fillStyle="#7b5cff";
  for(const k in terrain){
    const [x,y]=k.split(",").map(Number);
    const p=gridToScreen(x,y);
    if(VIEW_MODE==="angular"){
      ctx.beginPath();
      ctx.moveTo(p.x, p.y-tileSize/4);
      ctx.lineTo(p.x+tileSize/2, p.y);
      ctx.lineTo(p.x, p.y+tileSize/4);
      ctx.lineTo(p.x-tileSize/2, p.y);
      ctx.closePath(); ctx.fill();
    } else {
      ctx.fillRect(p.x,p.y,tileSize,tileSize);
    }
  }

  // regions
  Object.values(regions).forEach(r=>{
    const color={custom:"rgba(255,80,120,.35)",battle:"rgba(255,120,60,.35)",boss:"rgba(200,60,60,.45)",safe:"rgba(80,200,120,.3)"}[r.type]||"rgba(255,80,120,.35)";
    ctx.fillStyle=color;
    r.tiles.forEach(k=>{
      const [x,y]=k.split(",").map(Number);
      const p=gridToScreen(x,y);
      if(VIEW_MODE==="angular"){
        ctx.beginPath();
        ctx.moveTo(p.x, p.y-tileSize/4);
        ctx.lineTo(p.x+tileSize/2, p.y);
        ctx.lineTo(p.x, p.y+tileSize/4);
        ctx.lineTo(p.x-tileSize/2, p.y);
        ctx.closePath(); ctx.fill();
      } else {
        ctx.fillRect(p.x,p.y,tileSize,tileSize);
      }
    });
  });

  // objects
  objects.forEach(o=>{
    const p=gridToScreen(o.x,o.y);
    ctx.save();
    ctx.translate(p.x+tileSize/2,p.y+tileSize/2);
    ctx.rotate((o.rot||0)*Math.PI/180);
    ctx.fillStyle="#cccccc";
    ctx.fillRect(-tileSize/2,-tileSize/2,tileSize,tileSize);
    ctx.restore();
  });

  ctx.restore();
}

// ---- Zoom ----
canvas.addEventListener("wheel",e=>{
  e.preventDefault();
  const delta=e.deltaY>0?.9:1.1;
  zoomAt(e.clientX,e.clientY,delta);
},{passive:false});

function zoomAt(cx,cy,f){
  const newScale=Math.min(MAX_ZOOM,Math.max(MIN_ZOOM,scale*f));
  const rect=canvas.getBoundingClientRect();
  const x=(cx-rect.left-offsetX)/scale;
  const y=(cy-rect.top-offsetY)/scale;
  offsetX-=x*(newScale-scale);
  offsetY-=y*(newScale-scale);
  scale=newScale; draw();
}

resize(); draw();
console.info("View mode rehydrated:", VIEW_MODE);
</script>
</body>
</html>
