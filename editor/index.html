<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>RPG DREAM EDITOR</title>
<style>
:root{--bg:#0b0718;--panel:#16102a;--stroke:#3a2b7a;--primary:#7b5cff;--text:#efeaff;--white:#fff}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif}
#topbar{display:flex;align-items:center;gap:8px;padding:10px;background:var(--panel);border-bottom:1px solid var(--stroke)}
#topbar .spacer{flex:1}
button{background:var(--primary);border:none;border-radius:12px;color:#fff;padding:8px 12px;font-size:13px}
button.secondary{background:transparent;border:1px solid var(--primary)}
button.active{outline:2px solid #fff}
canvas{display:block;touch-action:none}
#toolbar{display:flex;gap:8px;padding:8px;background:#120b22;border-bottom:1px solid var(--stroke)}
#phaseLabel{position:fixed;left:50%;bottom:6px;transform:translateX(-50%);color:#7bffcc;font-weight:700;letter-spacing:.08em;text-shadow:0 0 6px rgba(123,255,204,.6)}
#toast{position:fixed;left:50%;bottom:40px;transform:translateX(-50%);background:#1b1340;border:1px solid var(--stroke);border-radius:12px;padding:8px 12px;font-size:12px;display:none}
</style>
</head>
<body>
<div id="topbar">
  <strong>Editor</strong>
  <div class="spacer"></div>
  <button id="saveBtn">Save</button>
</div>

<div id="toolbar">
  <button id="toolPaint">Paint</button>
  <button id="toolErase" class="secondary">Erase</button>
  <button id="toolPan" class="secondary">Pan</button>
</div>

<canvas id="canvas"></canvas>
<div id="phaseLabel">PHASE 14E.1b</div>
<div id="toast">Saved âœ”</div>

<script>
const active = JSON.parse(localStorage.getItem("rpgdream_active_project")||"null");
if(!active){ location.href="../manager/index.html"; }

const canvas=document.getElementById("canvas"), ctx=canvas.getContext("2d");
let dpr=window.devicePixelRatio||1;
const tileSize=Number(active.tile)||32;
let scale=1, offsetX=0, offsetY=0;

const terrain=new Map(Object.entries(active?.data?.map?.terrain||{}));

function resize(){
  canvas.width=innerWidth*dpr; canvas.height=(innerHeight-120)*dpr;
  canvas.style.width=innerWidth+"px"; canvas.style.height=(innerHeight-120)+"px";
  ctx.setTransform(dpr,0,0,dpr,0,0); draw();
}
window.addEventListener("resize",resize);

function draw(){
  ctx.save();
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.translate(offsetX,offsetY);
  ctx.scale(scale,scale);
  ctx.fillStyle="#7b5cff";
  for(const k of terrain.keys()){
    const [x,y]=k.split(",").map(Number);
    ctx.fillRect(x*tileSize,y*tileSize,tileSize,tileSize);
  }
  ctx.restore();
}

// ---- Save FIX ----
function saveProject(){
  const projects=JSON.parse(localStorage.getItem("rpgdream_projects")||"[]");
  const payload={ map:{ terrain:Object.fromEntries(terrain) } };
  const idx=projects.findIndex(p=>p.id===active.id);
  if(idx>=0){
    projects[idx].data=payload;
  } else {
    projects.push({...active,data:payload});
  }
  localStorage.setItem("rpgdream_projects",JSON.stringify(projects));
  showToast();
  console.info("Project saved");
}

saveBtn.addEventListener("click",saveProject);

function showToast(){
  toast.style.display="block";
  setTimeout(()=>toast.style.display="none",900);
}

resize(); draw();
</script>
</body>
</html>
