<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>RPG DREAM EDITOR</title>
<style>
:root{--bg:#0b0718;--panel:#16102a;--stroke:#3a2b7a;--primary:#7b5cff;--text:#efeaff;--muted:#b7b0e6}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif}
#topbar{display:flex;align-items:center;gap:8px;padding:10px;background:var(--panel);border-bottom:1px solid var(--stroke)}
#topbar .spacer{flex:1}
button{background:var(--primary);border:none;border-radius:12px;color:#fff;padding:8px 12px;font-size:13px}
button.secondary{background:transparent;border:1px solid var(--primary)}
button.active{outline:2px solid #fff}
canvas{display:block;touch-action:none}
#toolbar{display:flex;gap:8px;padding:8px;background:#120b22;border-bottom:1px solid var(--stroke)}
.tool-modal{position:fixed;right:12px;top:120px;background:var(--panel);border:1px solid var(--stroke);border-radius:14px;padding:12px;min-width:200px;z-index:10}
.tool-modal.hidden{display:none}
.tool-modal h4{margin:0 0 8px 0}
.tool-modal .close{float:right;background:transparent;color:#fff}
#floatSave{position:fixed;right:12px;bottom:12px;background:var(--panel);border:1px solid var(--stroke);border-radius:14px;padding:8px;display:flex;gap:8px;align-items:center}
#floatSave.hidden{display:none}
#toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#1b1340;border:1px solid var(--stroke);border-radius:12px;padding:8px 12px;font-size:12px;display:none}
</style>
</head>
<body>
<div id="topbar">
  <strong>Editor</strong>
  <div class="spacer"></div>
  <button id="saveBtn">Save</button>
  <button id="toggleFloat" class="secondary">Floating Save</button>
</div>
<div id="toolbar">
  <button id="toolPaint">Paint</button>
  <button id="toolErase" class="secondary">Erase</button>
  <button id="toolPan" class="secondary">Pan</button>
</div>
<canvas id="canvas"></canvas>

<div id="paintModal" class="tool-modal hidden">
  <button class="close" onclick="closeModals()">✕</button>
  <h4>Paint Tool</h4>
</div>
<div id="eraseModal" class="tool-modal hidden">
  <button class="close" onclick="closeModals()">✕</button>
  <h4>Erase Tool</h4>
</div>
<div id="panModal" class="tool-modal hidden">
  <button class="close" onclick="closeModals()">✕</button>
  <h4>Pan Tool</h4>
</div>

<div id="floatSave" class="hidden">
  <button id="floatSaveBtn">Save</button>
  <button class="secondary" onclick="floatSave.classList.add('hidden')">✕</button>
</div>
<div id="toast">Saved</div>

<script>
const active = JSON.parse(localStorage.getItem("rpgdream_active_project")||"null");
if(!active){ location.href="../manager/index.html"; }

const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
let dpr=window.devicePixelRatio||1, scale=1, offsetX=0, offsetY=0;
const tileSize=Number(active.tile)||32;
const viewMode=active.view||"topdown";

const GRID_PRESETS={small:20, medium:40, large:80};
const GRID_MAX=GRID_PRESETS[active.grid]||40;

const terrain=new Map();
let currentTool="paint";
let isPanning=false, panStart={x:0,y:0}, camStart={x:0,y:0};

function resize(){
  canvas.width=innerWidth*dpr;
  canvas.height=(innerHeight-120)*dpr;
  canvas.style.width=innerWidth+"px";
  canvas.style.height=(innerHeight-120)+"px";
  ctx.setTransform(dpr,0,0,dpr,0,0);
  draw();
}
window.addEventListener("resize",resize);

function gridToScreen(x,y){
  if(viewMode==="angular"){
    return { x:(x-y)*(tileSize/2), y:(x+y)*(tileSize/4) };
  }
  return { x:x*tileSize, y:y*tileSize };
}

// INVERSE mapping for input
function screenToGrid(px,py){
  if(viewMode==="angular"){
    const gx = Math.round((px/(tileSize/2) + py/(tileSize/4)) / 2);
    const gy = Math.round((py/(tileSize/4) - px/(tileSize/2)) / 2);
    return {x:gx,y:gy};
  }
  return {x:Math.floor(px/tileSize),y:Math.floor(py/tileSize)};
}

function draw(){
  ctx.save();
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.translate(offsetX,offsetY);
  ctx.scale(scale,scale);
  ctx.strokeStyle="rgba(255,255,255,.15)";
  for(let x=-GRID_MAX;x<=GRID_MAX;x++)for(let y=-GRID_MAX;y<=GRID_MAX;y++){
    const p=gridToScreen(x,y);
    if(viewMode==="angular"){
      ctx.beginPath();
      ctx.moveTo(p.x, p.y-tileSize/4);
      ctx.lineTo(p.x+tileSize/2, p.y);
      ctx.lineTo(p.x, p.y+tileSize/4);
      ctx.lineTo(p.x-tileSize/2, p.y);
      ctx.closePath(); ctx.stroke();
    } else ctx.strokeRect(p.x,p.y,tileSize,tileSize);
  }
  ctx.fillStyle="#7b5cff";
  terrain.forEach((_,k)=>{
    const [x,y]=k.split(",").map(Number);
    const p=gridToScreen(x,y);
    if(viewMode==="angular"){
      ctx.beginPath();
      ctx.moveTo(p.x, p.y-tileSize/4);
      ctx.lineTo(p.x+tileSize/2, p.y);
      ctx.lineTo(p.x, p.y+tileSize/4);
      ctx.lineTo(p.x-tileSize/2, p.y);
      ctx.closePath(); ctx.fill();
    } else ctx.fillRect(p.x,p.y,tileSize,tileSize);
  });
  ctx.restore();
}

canvas.addEventListener("pointerdown",e=>{
  const rect=canvas.getBoundingClientRect();
  const px=(e.clientX-rect.left-offsetX)/scale;
  const py=(e.clientY-rect.top-offsetY)/scale;

  if(currentTool==="pan"){
    isPanning=true;
    panStart={x:e.clientX,y:e.clientY};
    camStart={x:offsetX,y:offsetY};
    return;
  }

  const g=screenToGrid(px,py);
  if(g.x<-GRID_MAX||g.x>GRID_MAX||g.y<-GRID_MAX||g.y>GRID_MAX) return;

  if(currentTool==="paint") terrain.set(g.x+","+g.y,true);
  if(currentTool==="erase") terrain.delete(g.x+","+g.y);
  draw();
});

canvas.addEventListener("pointermove",e=>{
  if(currentTool==="pan" && isPanning){
    offsetX=camStart.x+(e.clientX-panStart.x);
    offsetY=camStart.y+(e.clientY-panStart.y);
    draw();
  }
});
canvas.addEventListener("pointerup",()=>isPanning=false);
canvas.addEventListener("pointerleave",()=>isPanning=false);

function closeModals(){ document.querySelectorAll('.tool-modal').forEach(m=>m.classList.add('hidden')); }
function setTool(t){
  currentTool=t;
  document.querySelectorAll('#toolbar button').forEach(b=>b.classList.remove('active'));
  closeModals();
  if(t==="paint"){ toolPaint.classList.add('active'); paintModal.classList.remove('hidden'); }
  if(t==="erase"){ toolErase.classList.add('active'); eraseModal.classList.remove('hidden'); }
  if(t==="pan"){ toolPan.classList.add('active'); panModal.classList.remove('hidden'); }
}
toolPaint.onclick=()=>setTool("paint");
toolErase.onclick=()=>setTool("erase");
toolPan.onclick=()=>setTool("pan");
setTool("paint");

function serialize(){
  const projects=JSON.parse(localStorage.getItem("rpgdream_projects")||"[]");
  const payload={map:{terrain:Object.fromEntries(terrain)}};
  const idx=projects.findIndex(p=>p.id===active.id);
  if(idx>=0) projects[idx].data=payload;
  localStorage.setItem("rpgdream_projects",JSON.stringify(projects));
}
function toast(){ toastEl.style.display="block"; setTimeout(()=>toastEl.style.display="none",900); }
saveBtn.onclick=()=>{ serialize(); toast(); };
floatSaveBtn.onclick=()=>{ serialize(); toast(); };
toggleFloat.onclick=()=>{ floatSave.classList.toggle('hidden'); };
const toastEl=document.getElementById('toast');

resize(); draw();
</script>
</body>
</html>
